# Note, this is a "low fi" solution to get things to work while we haven't settled on any migrations management.
#       only implemented like this until we have chance to discuss a more pollished solution.

# NOTE: This is very brittle code, it will break if the password, hasura url or database changes.
#       Good to see the API though, we could write this in code to be more robust once things have settled a bit more.

# Source: https://hasura.io/docs/latest/api-reference/metadata-api/table-view/#metadata-pg-track-table

{{#each entities as |entity|}}
curl -X POST localhost:8080/v1/metadata \
  -H "Content-Type: application/json" \
  -H "X-Hasura-Role: admin" \
  -H "X-Hasura-Admin-Secret: testing" \
  -d '{
  "type": "pg_track_table",
  "args": {
    "source": "public",
    "schema": "public",
    "name": "{{entity.name.uncapitalized}}"
  }
}'
{{/each}}
# reference: https://hasura.io/docs/latest/api-reference/metadata-api/permission/#metadata-pg-create-select-permission

#Do this for the raw events table as well
curl -X POST localhost:8080/v1/metadata \
  -H "Content-Type: application/json" \
  -H "X-Hasura-Role: admin" \
  -H "X-Hasura-Admin-Secret: testing" \
  -d '{
  "type": "pg_track_table",
  "args": {
    "source": "public",
    "schema": "public",
    "name": "raw_events"
  }
}'

#Do this for the raw events table as well
curl -X POST localhost:8080/v1/metadata \
  -H "Content-Type: application/json" \
  -H "X-Hasura-Role: admin" \
  -H "X-Hasura-Admin-Secret: testing" \
  -d '{
  "type": "pg_track_table",
  "args": {
    "source": "public",
    "schema": "public",
    "name": "dynamic_contract_registry"
  }
}'

{{#each entities as |entity|}}
curl -X POST localhost:8080/v1/metadata \
  -H "Content-Type: application/json" \
  -H "X-Hasura-Role: admin" \
  -H "X-Hasura-Admin-Secret: testing" \
  -d '{
    "type": "pg_create_select_permission",
    "args": {
        "table": "{{entity.name.uncapitalized}}",
        "role": "public",
        "source": "default",
        "permission": {
            "columns": "*",
            "filter": {}
        }
    }
}'
{{/each}}

#Do this for the raw events table as well
curl -X POST localhost:8080/v1/metadata \
  -H "Content-Type: application/json" \
  -H "X-Hasura-Role: admin" \
  -H "X-Hasura-Admin-Secret: testing" \
  -d '{
    "type": "pg_create_select_permission",
    "args": {
        "table": "raw_events",
        "role": "public",
        "source": "default",
        "permission": {
            "columns": "*",
            "filter": {}
        }
    }
}'
#Do this for the dynamic_contract_registry table as well
curl -X POST localhost:8080/v1/metadata \
  -H "Content-Type: application/json" \
  -H "X-Hasura-Role: admin" \
  -H "X-Hasura-Admin-Secret: testing" \
  -d '{
    "type": "pg_create_select_permission",
    "args": {
        "table": "dynamic_contract_registry",
        "role": "public",
        "source": "default",
        "permission": {
            "columns": "*",
            "filter": {}
        }
    }
}'

{{#each entities as |entity|}}
{{#each entity.relational_params as | relational_param | }}
curl -X POST localhost:8080/v1/metadata \
  -H "Content-Type: application/json" \
  -H "X-Hasura-Role: admin" \
  -H "X-Hasura-Admin-Secret: testing" \
  -d '{
    "type": "pg_create_{{relational_param.relationship_type}}_relationship",
    "args": {
        "table": "{{entity.name.uncapitalized}}",
        "name": "{{relational_param.relational_key.uncapitalized}}Map",
        "source": "default",
        "using": {
            "manual_configuration" : {
                "remote_table" : "{{relational_param.mapped_entity.uncapitalized}}",
                "column_mapping" : {
                    "{{relational_param.relational_key.uncapitalized}}" : "id"
                }
            }
        }
    }
}'
{{/each}}
{{/each}}
