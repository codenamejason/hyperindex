let globalEventsSummaryKey = "GlobalEventsSummary"

module BigInt = Ethers.BigInt

let initialEventsSummary: Entities.EventsSummary.t = {
  id: globalEventsSummaryKey,
{{#each imported_contracts as |contract|}}
  {{#each contract.imported_events as |event|}}
    {{contract.name.uncapitalized}}_{{event.name.capitalized
    }}Count: BigInt.fromInt(0),
  {{/each}}
{{/each}}
}

{{#each imported_contracts as |contract|}}
  {{#each contract.imported_events as |event|}}
Handlers.{{contract.name.capitalized
    }}.{{event.name.capitalized
    }}.handler(async ({event, context}) => {
  let summary = await context.eventsSummary.get(globalEventsSummaryKey)

  let currentSummaryEntity = summary->Belt.Option.getWithDefault(initialEventsSummary)

  let nextSummaryEntity = {
    ...currentSummaryEntity,
    {{contract.name.uncapitalized}}_{{event.name.capitalized
    }}Count: currentSummaryEntity.{{contract.name.uncapitalized
    }}_{{event.name.capitalized
    }}Count->BigInt.add(BigInt.fromInt(1)),
  }

  let {{contract.name.uncapitalized
    }}_{{event.name.capitalized}}: Types.{{contract.name.uncapitalized
    }}_{{event.name.capitalized
    }} = {
    id: event.transactionHash ++ event.logIndex->Belt.Int.toString,
    {{#each event.params as |param|}}
      {{param.entity_key.uncapitalized
      }}: event.params.{{param.event_key.uncapitalized}}
      {{#if param.tuple_param_accessor_indexes}}
        {{#each param.tuple_param_accessor_indexes as |index|}}
          ->Utils.Tuple.get({{index}})->Belt.Option.getUnsafe
        {{/each}}
      {{/if}}
      {{#if param.is_eth_address}}
        ->Ethers.ethAddressToString
      {{/if}}
      ,
    {{/each}}
    eventsSummary: globalEventsSummaryKey,
  }

  context.eventsSummary.set(nextSummaryEntity)
  context.{{contract.name.uncapitalized
    }}_{{event.name.capitalized}}.set({{contract.name.uncapitalized
    }}_{{event.name.capitalized}})
})
  {{/each}}
{{/each}}
