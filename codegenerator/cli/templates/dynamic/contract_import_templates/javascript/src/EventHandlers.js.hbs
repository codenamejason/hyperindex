/*
 *Please refer to https://docs.envio.dev for a thorough guide on all Envio indexer features*
 */
  const {
{{#each imported_contracts as |contract|}}
 {{contract.name.capitalized}},
{{/each}}
} = require("generated");

const GLOBAL_EVENTS_SUMMARY_KEY = "GlobalEventsSummary";

module.exports = {
  GLOBAL_EVENTS_SUMMARY_KEY,
};

const INITIAL_EVENTS_SUMMARY = {
  id: GLOBAL_EVENTS_SUMMARY_KEY,
{{#each imported_contracts as |contract|}}
  {{#each contract.imported_events as |event|}}
    {{contract.name.uncapitalized}}_{{event.name.capitalized}}Count: BigInt(0),
  {{/each}}
{{/each}}
};

{{#each imported_contracts as |contract|}}
  {{#each contract.imported_events as |event|}}
    {{contract.name.capitalized}}.{{event.name.capitalized
    }}.loader(({event, context}) => {
  context.EventsSummary.load(GLOBAL_EVENTS_SUMMARY_KEY);
});

    {{contract.name.capitalized}}.{{event.name.capitalized
    }}.handler(({event, context}) => {
  const summary = context.EventsSummary.get(GLOBAL_EVENTS_SUMMARY_KEY);

  const currentSummaryEntity = summary ?? INITIAL_EVENTS_SUMMARY;

  const nextSummaryEntity = {
    ...currentSummaryEntity,
    {{contract.name.uncapitalized}}_{{event.name.capitalized
    }}Count: currentSummaryEntity.{{contract.name.uncapitalized
    }}_{{event.name.capitalized
    }}Count + BigInt(1),
  };

  const {{contract.name.uncapitalized
    }}_{{event.name.capitalized
    }} = {
    id: event.transactionHash + event.logIndex.toString(),
    {{#each event.params as |param|}}
      {{param.entity_key.uncapitalized
      }}: event.params.{{param.event_key.uncapitalized}}{{#if
        param.tuple_param_accessor_indexes
      }}
        {{#each param.tuple_param_accessor_indexes as |index|}}
          [{{index}}]
        {{/each}}
      {{/if}}
      ,
    {{/each}}
    eventsSummary: GLOBAL_EVENTS_SUMMARY_KEY,
  };

  context.EventsSummary.set(nextSummaryEntity);
  context.{{contract.name.capitalized
    }}_{{event.name.capitalized}}.set({{contract.name.uncapitalized
    }}_{{event.name.capitalized}});
});
  {{/each}}
{{/each}}
